<div class="books-management">
  <h2>ניהול ספרים</h2>

  <!-- סינון -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="search">חיפוש:</label>
      <input 
        id="search"
        type="text" 
        placeholder="חיפוש לפי שם ספר או מחבר..." 
        [(ngModel)]="searchQuery"
        (input)="filterBooks()"
      />
    </div>

    <div class="filter-group">
      <label for="author-filter">מחבר:</label>
      <select id="author-filter" [(ngModel)]="filterAuthor" (change)="filterBooks()">
        <option value="">הכל</option>
        <option *ngFor="let author of uniqueAuthors" [value]="author">{{ author }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="category-filter">קטגוריה:</label>
      <select id="category-filter" [(ngModel)]="filterCategory" (change)="filterBooks()">
        <option value="">הכל</option>
        <option *ngFor="let category of uniqueCategories" [value]="category">{{ category }}</option>
      </select>
    </div>

    <button class="btn-clear" (click)="searchQuery = ''; filterAuthor = ''; filterCategory = ''; filterBooks()">
      🔄 ניקוי סינונים
    </button>
  </div>

  <!-- טבלת הספרים -->
  <div class="books-table-wrapper">
    <table class="books-table">
      <thead>
        <tr>
          <th>שם הספר</th>
          <th>מחבר</th>
          <th>מחיר</th>
          <th>גודל</th>
          <th>קטגוריות</th>
          <th>תמונה</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let book of books">
          <td>{{ book.bookName }}</td>
          <td>{{ book.author }}</td>
          <td class="price">₪{{ book.price }}</td>
          <td>{{ book.size || '-' }}</td>
          <td class="categories">
            <span *ngFor="let cat of book.category" class="category-badge">
              {{ cat.sub || cat.main }}
            </span>
          </td>
          <td class="image-cell">
            <button 
              *ngIf="book.picture" 
              class="btn-view-image" 
              (click)="viewImage(book)"
              title="הצג תמונה"
            >
              🖼️ צפייה
            </button>
            <span *ngIf="!book.picture" class="no-image">אין תמונה</span>
          </td>
          <td class="actions">
            <button class="btn-edit" (click)="editBook(book)" title="עריכה">✏️</button>
            <button class="btn-delete" (click)="deleteBook(book.id)" title="מחיקה">🗑️</button>
          </td>
        </tr>
        <tr *ngIf="books.length === 0">
          <td colspan="7" class="no-results">אין ספרים המתאימים לסינון</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- מודל להצגת תמונה בגדול -->
  <div *ngIf="showImageModal" class="image-modal-overlay" (click)="closeImageModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <div class="image-modal-header">
        <h3>{{ selectedImageBook?.bookName }}</h3>
        <button class="btn-close" (click)="closeImageModal()">✕</button>
      </div>
      <div class="image-modal-body">
        <img 
          *ngIf="selectedImageBook?.picture" 
          [src]="getImageUrl(selectedImageBook.picture)" 
          [alt]="selectedImageBook?.bookName"
        />
        <p *ngIf="!selectedImageBook?.picture">אין תמונה להצגה</p>
      </div>
    </div>
  </div>

  <!-- מודל לעריכת ספר -->
  <div *ngIf="isEditMode && editingBook" class="edit-modal-overlay" (click)="cancelEdit()">
    <div class="edit-modal-content" (click)="$event.stopPropagation()">
      <div class="edit-modal-header">
        <h3>עריכת ספר</h3>
        <button class="btn-close" (click)="cancelEdit()">✕</button>
      </div>
      <div class="edit-modal-body">
        <div class="form-group">
          <label>שם הספר:</label>
          <input type="text" [(ngModel)]="editingBook.bookName" />
        </div>

        <div class="form-group">
          <label>מחבר:</label>
          <input type="text" [(ngModel)]="editingBook.author" />
        </div>

        <div class="form-group">
          <label>מחיר:</label>
          <input type="number" [(ngModel)]="editingBook.price" />
        </div>

        <div class="form-group">
          <label>גודל:</label>
          <input type="text" [(ngModel)]="editingBook.size" />
        </div>

        <div class="form-group">
          <label>תיאור:</label>
          <textarea [(ngModel)]="editingBook.description" rows="4"></textarea>
        </div>

        <div class="form-group">
          <label>תמונה:</label>
          <div class="image-section">
            <!-- דרופדאון לבחירת תמונה -->
            <div class="image-dropdown">
              <button class="btn-toggle-image" (click)="toggleImageOptions()">
                🖼️ {{ newImagePreview ? 'שינוי תמונה' : 'העלה תמונה חדשה' }}
              </button>
              <div *ngIf="editingBook.showImageOptions" class="image-options">
                <div class="current-image" *ngIf="editingBook.picture && !newImagePreview">
                  <p class="label-small">תמונה קיימת:</p>
                  <p class="filename">{{ editingBook.picture }}</p>
                  <img 
                    [src]="getImageUrl(editingBook.picture)" 
                    alt="preview" 
                    class="edit-preview-img"
                  />
                </div>
                <div class="file-input-wrapper">
                  <input 
                    type="file" 
                    accept="image/*"
                    (change)="onImageSelectedForEdit($event)"
                    class="file-input"
                    #fileInput
                  />
                  <button class="btn-upload" (click)="fileInput.click()">
                    📁 בחר תמונה חדשה
                  </button>
                </div>
                <div class="new-image-preview" *ngIf="newImagePreview">
                  <p class="label-small">תמונה חדשה:</p>
                  <img [src]="newImagePreview" alt="new-preview" class="edit-preview-img" />
                  <button class="btn-remove-image" (click)="removeNewImage()">
                    ✕ הסר תמונה חדשה
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="edit-modal-footer">
        <button class="btn-cancel" (click)="cancelEdit()">ביטול</button>
        <button class="btn-save" (click)="saveEdit()">שמור</button>
      </div>
    </div>
  </div>
</div>

